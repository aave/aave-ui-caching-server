name: On Pull Request

concurrency:
  group: "${{ github.workflow }}-${{ github.head_ref || github.ref }}"
  cancel-in-progress: true

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      image_name: ${{ steps.build.outputs.image_name }}
    steps:
      - uses: actions/checkout@v2

      - uses: ./.github/actions/build
        name: Build image
        id: build

  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - uses: ./.github/actions/test
        name: Run tests

  deploy_dev:
    runs-on: ubuntu-latest
    environment: preview
    needs: build
    container:
      image: ghcr.io/helmfile/helmfile-ubuntu:v0.145.4
    strategy:
      fail-fast: false
      matrix:
        CHAIN_ID: ["1", "137", "43114"]
    steps:
      - uses: actions/checkout@v2

      - name: Set k8s namespace
        shell: bash
        run: |
          cat <<EOF | tr -c '[:alnum:]-=\n_' '-' >> ${GITHUB_ENV}
          NAMESPACE=cache-${NS_SUFFIX,,}
          ENV_NAME=${{ github.head_ref }}
          EOF
        env:
          NS_SUFFIX: "${{ github.head_ref }}-${{ matrix.CHAIN_ID }}"

      - name: Set up kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.DEV_KUBECONFIG }}" > ~/.kube/config

      - name: Apply k8s resources
        shell: bash
        env:
          MAINNET_RPC: "${{ secrets.MAINNET_RPC }}"
          POLYGON_RPC: "${{ secrets.POLYGON_RPC }}"
          DOMAIN: "${{ env.NAMESPACE }}.aaw.fi"
          CHAIN_ID: "${{ matrix.CHAIN_ID }}"
          IMAGE: "${{ needs.build.outputs.image_name }}"
          COMMIT_SHA: "${{ github.sha }}"
          HELM_PLUGINS: '/root/.local/share/helm/plugins'
        run: |
          helmfile sync && exit 0 || true
          helmfile status | grep pending-upgrade
          RELEASE="$(helmfile status | grep NAME: | awk '{print $2}')"
          REVISION="$(helmfile status | grep REVISION: | awk '{print $2}')"
          helm rollback --wait -n "${NAMESPACE}" "${RELEASE}" "$((REVISION-1))"
          helmfile sync

      - uses: actions/github-script@v5
        if: ${{ github.event.action == 'opened' || github.event.action == 'reopened' }}
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.payload.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'Preview link for chain ${{ matrix.CHAIN_ID }}: https://${{ env.NAMESPACE }}.aaw.fi/'
            })
